---
title: "foieGras manual"
author: "Ian Jonsen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
### foieGras models
This vignette provides a (very) brief overview of how to use `foieGras` to filter animal track locations obtained via the Argos satellite system. `foieGras` provides two state-space models (SSMs) for filtering (ie. estimating "true" locations and associated movement model parameters, while accounting for error-prone observations):  

- a simple Random Walk model, `rw`
- a Correlated Random Walk model, `crw`  

Both models are continuous-time models, that is, they account for time intervals between successive observations, thereby naturally accounting for the irregularly-timed nature of most Argos data. We won't dwell on the details of the models here, those will come in a future paper, except to say there may be advantages to choosing one over the other in certain circumstances. The Random Walk model tends not to deal well with small to moderate gaps (relative to a specified time step) in observed locations and can over-fit to particularly noisy data. The Correlated Random Walk model can often deal better with these small to moderate data gaps and smooth through noisy data but tends to estimate nonsensical movement through larger data gaps.

### input data
`foieGras` expects data to be provided in one of four possible formats.

1) a `data.frame` or `tibble` that looks like this
```{r data 1, echo = FALSE}
data(ellie, package = "foieGras")
head(ellie)
```
where the Argos data are provided via CLS Argos' Kalman filter model (KF) and include error ellipse information for each observed location.  

2) a `data.frame` or `tibble` that looks like this
```{r data 2, echo = FALSE}
data(rope, package = "foieGras")
head(rope)
```
where the Argos data are provided via CLS Argos' Least-Squares model (LS) and do not include error ellipse information.

3) a data.frame or tibble that includes observations with missing KF error ellipse information
```{r data 3, echo = FALSE}
data(ellie, package = "foieGras")
ellie[3:5, c("smaj","smin","eor")] <- NA
head(ellie)
```
in this situation, `foieGras` treats observations with missing error ellipse information as though they are LS-based observations.

4) a `sf` object where observations have any of the previous 3 structures and also include `CRS` information
```{r data 4, echo = FALSE, message=FALSE}
library(tidyverse)
data(ellie, package = "foieGras")
foo <- sf::st_as_sf(ellie, coords=c("lon","lat"), crs = 4326) %>%
  sf::st_transform(., crs = "+init=epsg:3031 +units=km")
head(foo)
```

### fitting a foieGras model
model fitting is comprised of 2 steps: a prefilter step where a number of checks are made on the input data (see `?foieGras::prefilter` for details), including applying the `argsofilter::sdafilter` to identify extreme outlier observations. Additionally, if the input data are not supplied as an `sf` object, `prefilter` guesses at an appropriate projection to apply to the data. The SSM is then fit to this projected version of the data. Users invoke this process via the `fit_ssm` function:
```{r fit_ssm, message=FALSE}
require(tidyverse)
require(foieGras)
## load foieGras example data
data(ellie)
## prefilter and fit Random Walk SSM, using a 24 h time step
fit <- fit_ssm(ellie, model = "rw", time.step = 24)
```
these are the minimum arguments required: the input data, the model ("rw" or "crw") and the time.step (in h) to which locations are predicted. Additional control can be exerted over the prefiltering step, via the `vmax`, `ang`, `distlim`, `spdf` and `min.dt` arguments. see `?foieGras::fit_ssm` for details, the defaults for these arguments are quite conservative, usually leading to relative few observations being flagged to be ignored by the SSM. Additional control over the SSM fitting step can also be exerted but these should rarely need to be accessed by users and will not be dealt with here.

### accessing and visualising model fit objects
Simple summary information about the `foieGras` fit can be obtained by calling the fit object:
```{r fit summary}
fit$ssm[[1]]
```
and a summary `plot` method allows a quick visual of the SSM fit to the data:
```{r fit plot, fig.width=7,fig.height=7}
# plot time-series of the predicted values
plot(fit$ssm[[1]], what = "predicted")
```
The predicted values are the state estimates predicted at regular time intervals, specified by `time.step` (here every 24 h). Fitted values (not shown) are the state esimates corresponding to the time of each observation; their time-series are plotted by default - `plot(fit$ssm[[1]])`.

Estimated tracks can be mapped using the `foieGras`-guessed projection
```{r quickmap, fig.width=7, fig.height=7}
## include prefiltered observations
quickmap(fit$ssm[[1]], what = "predicted", obs = TRUE)
```

The tracks can also be transformed to a user-specified projection
```{r quickmap reproject, fig.width=7, fig.height=7}
## use Antarctic Polar Stereographic projection approximately centred on the track midpoint
quickmap(fit$ssm[[1]], what = "p", crs = "+init=epsg:3031 +lon_0=85")
```

Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
